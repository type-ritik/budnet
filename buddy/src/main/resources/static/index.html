<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
</head>
<body>
    <h1>WebSocket Example</h1>
    <button onclick="sendMessage('/app/chat.send', 'Hello World', 'text/plain')">I Send Message</button>
    <input placeholder="Enter any text" id="inputed" />
    <input placeholder="Enter receiverId" id="receiver"/>
    <button onclick="sendToUser()">Chat On</button>
<script>

    const input = document.getElementById("inputed");
    const receiver = document.getElementById("receiver");

    const sendToUser = () => {
        const message = input.value;
        const id = receiver.value;
        const payload = {
            message,
            receiverId: id
        }

        ws.send(`SEND\ndestination:/app/chat.online\ncontent-type:application/json\n\n${JSON.stringify(payload)}\u0000`)

        // sendMessage(`/app/chat.online`, {message: message, receiverId: id}, 'application/json');
    }

    const randomUUID = async () => {
        const res = await fetch("http://localhost:8080/uuid/random", {
            method: "GET"
        });
        if (res.ok) {
            const data = await res.text();
            console.log(`UserId: ${data}`);
            return data;
        }
    }

    function buildFrame(command, headers = {}, body = "") {
        let frame = command + "\n";
        for (const key in headers) {
            frame += `${key}:${headers[key]}\n`;
        }

        frame += "\n";
        frame += body;
        frame += "\u0000";
        return frame;
    }

    function parseFrame(raw) {
        const [headerPart, bodyPart] = raw.split("\n\n");
        const lines = headerPart.split("\n");
        const command = lines[0];

        const headers = {};
        for (let i = 1; i < lines.length; i++) {
            const [k,v] = lines[i].split(":");
            headers[k] = v;
        }

        return {
            command, headers, body: bodyPart?.replace("\u0000", "")
        };
    }

    const STATE = {
        DISCONNECTED: "DISCONNECTED",
        CONNECTING: "CONNECTING",
        CONNECTED: "CONNECTED",
        SUBSCRIBED: "SUBSCRIBED"
    };

    let state = STATE.DISCONNECTED;

    const ws = new WebSocket("ws://localhost:8080/buddy");

    ws.onopen = () => {
        state = STATE.CONNECTING;
        ws.send(buildFrame("CONNECT", {
            "accept-version": "1.2",
            host:"localhost"
        }));
    };

    ws.onmessage = (event) => {
        console.log("I receive message everytime i hit server event",event);
        const frame = parseFrame(event.data);
        routeFrame(frame);
    }

    ws.onclose = () => {
        state = STATE.DISCONNECTED;
        console.log("Disconnected");
    }

    async function routeFrame(frame) {
        switch (frame.command) {
            case "CONNECTED":
                state = STATE.CONNECTED;
                const uuid = await randomUUID();
                subscribe(["/user/queue/messages", "/topic/messages"], uuid);
                break;

            case "SUBSCRIBED":
                console.log("Subscribed successfully");
                break;

            case "MESSAGE":
                console.log("Received message:", frame.body);
                break;

            case "ERROR":
                console.log("STOMP ERROR: ", frame);
                break;

            default:
                console.warn("Unknown frame: ", frame);
                break;
        }
    }

    function subscribe(destination, uuid) {
        if (state !== STATE.CONNECTED) return;

        if (destination.length == 0) {
            console.warn("No destinations provided for subscription");
            return;
        } else if(destination.length == 1) {
            ws.send(buildFrame("SUBSCRIBE", {
                id: uuid,
                destination
            }));
        } else {
            destination.forEach(dest => {
                ws.send(buildFrame("SUBSCRIBE", {
                    id: uuid,
                    destination: dest
                }));
            });
        }


        state = STATE.SUBSCRIBED;
    }

    function sendMessage(destination, message, type) {
        if (state !== STATE.SUBSCRIBED) return;

        ws.send(buildFrame("SEND", {
            destination,
            "content-type": type
        }, message));
    }
</script>
</body>
</html>
